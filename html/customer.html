<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer - GoBike</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../css/style.css">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Firebase Config -->
<script src="../js/firebase-config.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  #map { height: 400px; width: 100%; margin-bottom: 10px; }
  .order-card { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
  .order-card input, .order-card button { width: 100%; margin: 5px 0; padding: 8px; border-radius: 4px; }
</style>

</head>
<body>

<div class="app">
  <h2>Customer Dashboard</h2>

  <div id="map"></div>

  <div class="order-card">
    <h3>Place New Order</h3>
    <input type="text" id="destination" placeholder="Destination Address">
    <button onclick="placeOrder()">Place Order</button>
    <p id="order-status"></p>
  </div>
</div>

<script>
// ---------------- Leaflet Map Setup ----------------
let map = L.map('map').setView([16.82, 96.15], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Customer location marker
let customerMarker;

// ---------------- Firebase Auth ----------------
auth.signInAnonymously()
.then(res => {
  const uid = res.user.uid;

  // Get user's current location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      customerMarker = L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();
      map.setView([lat, lng], 15);

      // Optional: Save customer location to Firestore
      db.collection("locations").doc(uid).set({
        lat: lat,
        lng: lng,
        role: "customer",
        name: localStorage.getItem("name") || "Customer",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

    }, err => alert("GPS Error: " + err.message));
  }

}).catch(err => alert("Auth Error: " + err.message));

// ---------------- Place Order ----------------
function placeOrder() {
  const destination = document.getElementById("destination").value.trim();
  if (!destination) return alert("Enter destination");

  const uid = auth.currentUser.uid;
  db.collection("orders").add({
    customerId: uid,
    destination: destination,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    document.getElementById("order-status").innerText = "Order placed successfully!";
    document.getElementById("destination").value = "";
  }).catch(err => {
    document.getElementById("order-status").innerText = "Error: " + err.message;
  });
}
</script>

</body>
</html>
