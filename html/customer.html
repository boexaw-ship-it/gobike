<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Dashboard - GoBike</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../js/firebase-config.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body {font-family:sans-serif;margin:0;padding:10px;}
  #map {height:500px;width:100%;border-radius:8px;margin-top:10px;}
  button {padding:8px 12px;margin-top:10px;font-size:16px;}
</style>
</head>
<body>

<div class="app">
  <h2>Customer Dashboard</h2>
  <p id="status">Loading map...</p>
  <div id="map"></div>
  <p id="info"></p>
  <button id="submitOrder" disabled>Submit Order</button>
</div>

<script>
// ---------------- AUTH CHECK ----------------
auth.onAuthStateChanged(user=>{
  if(!user) location.href="../index.html";
  db.collection("users").doc(user.uid).get().then(doc=>{
    if(!doc.exists || doc.data().role !== "customer"){ auth.signOut(); location.href="../index.html"; }
  });
});

// ---------------- MAP ----------------
let map = L.map('map').setView([16.82,96.15],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

const riderIcon = L.icon({iconUrl:'../assets/bike.png',iconSize:[40,40],iconAnchor:[20,40]});
let markers={}, routes={}, colors={}, pickupMarker=null, dropMarker=null, orderLine=null;

// Random color for rider paths
function getRandomColor(uid){
  if(colors[uid]) return colors[uid];
  const c = '#'+Math.floor(Math.random()*16777215).toString(16);
  colors[uid] = c;
  return c;
}

// ---------------- PICKUP / DROP ----------------
map.on('click', function(e){
  if(!pickupMarker){
    pickupMarker = L.marker(e.latlng).addTo(map).bindPopup("Pickup").openPopup();
    document.getElementById("info").innerText = `Pickup at ${e.latlng.lat.toFixed(5)},${e.latlng.lng.toFixed(5)}`;
  } else if(!dropMarker){
    dropMarker = L.marker(e.latlng).addTo(map).bindPopup("Drop").openPopup();
    if(orderLine) map.removeLayer(orderLine);
    orderLine = L.polyline([pickupMarker.getLatLng(), dropMarker.getLatLng()], {color:'blue', weight:4}).addTo(map);
    document.getElementById("info").innerText += ` | Drop at ${e.latlng.lat.toFixed(5)},${e.latlng.lng.toFixed(5)}`;
    document.getElementById("submitOrder").disabled = false;
  }
});

// ---------------- LIVE RIDERS ----------------
db.collection("locations").where("role","==","rider").onSnapshot(snapshot=>{
  snapshot.docs.forEach(doc=>{
    const data = doc.data(); const rid = doc.id;
    if(!data.lat || !data.lng) return;
    const pos = [data.lat, data.lng];
    const popup = `<b>${data.name||rid}</b><br>Updated:${data.updatedAt?data.updatedAt.toDate().toLocaleTimeString():''}`;

    if(markers[rid]){
      markers[rid].setLatLng(pos).setPopupContent(popup);
    } else {
      markers[rid] = L.marker(pos,{icon:riderIcon}).addTo(map).bindPopup(popup);
    }

    if(!routes[rid]){
      routes[rid] = L.polyline([pos],{color:getRandomColor(rid), weight:4}).addTo(map);
    } else {
      const latlngs = routes[rid].getLatLngs();
      latlngs.push(pos);
      routes[rid].setLatLngs(latlngs);
    }
  });
});

// ---------------- SUBMIT ORDER ----------------
document.getElementById("submitOrder").onclick = ()=>{
  if(!pickupMarker || !dropMarker) return alert("Pickup and Drop required");
  const pickup = pickupMarker.getLatLng();
  const drop = dropMarker.getLatLng();
  const distance = map.distance(pickup, drop)/1000; // km
  const price = Math.ceil(distance*1000);

  db.collection("orders").add({
    customerId: auth.currentUser.uid,
    customerName: auth.currentUser.displayName || auth.currentUser.email,
    pickup:{lat:pickup.lat,lng:pickup.lng},
    drop:{lat:drop.lat,lng:drop.lng},
    price: price,
    status:"pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    alert(`Order submitted! Distance:${distance.toFixed(2)} km Price:${price} Ks`);
    map.removeLayer(pickupMarker); map.removeLayer(dropMarker);
    if(orderLine) map.removeLayer(orderLine);
    pickupMarker=null; dropMarker=null; orderLine=null;
    document.getElementById("submitOrder").disabled=true;
    document.getElementById("info").innerText="";
  });
};
</script>
</body>
</html>
