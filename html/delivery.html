<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rider Delivery - GoBike</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../js/firebase-config.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  .app { padding: 15px; font-family: sans-serif; }
  #map { height: 400px; width: 100%; margin-top: 15px; }
  #orders { margin-top: 15px; border-collapse: collapse; width: 100%; }
  #orders th, #orders td { border: 1px solid #ccc; padding: 6px; text-align: left; }
  #orders th { background: #eee; }
  #status { margin-top: 10px; font-weight: bold; }
</style>

</head>
<body>

<div class="app">
  <h2>Rider Delivery Dashboard</h2>
  <p id="status">Initializing...</p>

  <h3>Assigned Orders</h3>
  <table id="orders">
    <thead>
      <tr><th>Order ID</th><th>Customer</th><th>Destination</th><th>Status</th></tr>
    </thead>
    <tbody id="orders-list"></tbody>
  </table>

  <div id="map"></div>
</div>

<script>
let uid = null;
let map, riderMarker, routeLine, routeCoords = [];

// ---------------- Anonymous Login ----------------
auth.signInAnonymously()
.then(res=>{
  uid = res.user.uid;
  const name = localStorage.getItem("name") || "Rider";
  document.getElementById("status").innerText = "Logged in as UID: " + uid;

  // Save rider profile
  db.collection("users").doc(uid).set({
    name: name,
    role: "rider",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  initMap();
  watchLocation();
  loadAssignedOrders();
})
.catch(err=>{
  document.getElementById("status").innerText = "Auth Error: " + err.message;
});

// ---------------- Map Setup ----------------
function initMap(){
  map = L.map('map').setView([16.82, 96.15], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const riderIcon = L.icon({
    iconUrl: '../assets/bike.png',
    iconSize: [40,40],
    iconAnchor: [20,40],
    popupAnchor: [0,-40]
  });

  riderMarker = L.marker([16.82,96.15], {icon: riderIcon}).addTo(map).bindPopup("You are here");

  routeLine = L.polyline([], {color:'red', weight:4}).addTo(map);
}

// ---------------- GPS Watch ----------------
function watchLocation(){
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // Update marker + route
      const latlng = [lat,lng];
      riderMarker.setLatLng(latlng).bindPopup("You are here").openPopup();
      routeCoords.push(latlng);
      routeLine.setLatLngs(routeCoords);

      map.setView(latlng, map.getZoom());

      // Save location to Firestore
      db.collection("locations").doc(uid).set({
        lat: lat,
        lng: lng,
        name: localStorage.getItem("name")||"Rider",
        role: "rider",
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      document.getElementById("status").innerText = GPS OK: Lat ${lat.toFixed(5)}, Lng ${lng.toFixed(5)};
    },
    err=>{
      document.getElementById("status").innerText = "GPS Error: "+err.message;
    },{
      enableHighAccuracy:true, maximumAge:0, timeout:5000
    });
  } else {
    document.getElementById("status").innerText="Geolocation not supported.";
  }
}

// ---------------- Assigned Orders ----------------
